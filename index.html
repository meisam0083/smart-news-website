<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحلیل هوشمند اخبار</title>
    <!-- پالت رنگی انتخاب شده: رنگ‌های خنثی گرم و سبز آرامش‌بخش -->
    <!-- طرح‌بندی ساختار برنامه: طرح‌بندی واکنش‌گرا دو ستونی. ستون سمت راست شامل فیلترهای ناوبری (دسته‌بندی‌ها و نوار جستجو) و یک نمودار دونات تعاملی برای نمای کلی بصری. ستون سمت چپ ناحیه محتوای اصلی است که یا یک گرید از مقالات خبری یا جزئیات کامل مقاله انتخاب شده را نمایش می‌دهد. این ساختار اصلی-جزئی کاربرپسند است، ناوبری را از محتوا جدا می‌کند، و امکان فیلتر سریع و کاوش را در یک صفحه واحد فراهم می‌کند، که باعث بهبود قابلیت استفاده می‌شود. -->
    <!-- انتخاب بصری‌سازی و محتوا:
        - اطلاعات گزارش: مقالات خبری با دسته‌بندی‌ها. هدف: ارائه خلاصه‌ای سطح بالا از توزیع محتوا. بصری‌سازی/ارائه: نمودار دونات (Chart.js/Canvas) که تعداد مقالات را بر اساس دسته‌بندی نشان می‌دهد. تعامل: کلیک روی یک بخش از نمودار، لیست مقالات را در ستون سمت چپ فیلتر می‌کند. توجیه: راهی سریع، بصری و جذاب برای ناوبری و فیلتر کردن محتوا ارائه می‌دهد. کتابخانه: Chart.js.
        - اطلاعات گزارش: لیست همه مقالات. هدف: امکان مرور و انتخاب اخبار برای کاربران. بصری‌سازی/ارائه: گرید واکنش‌گرا از کارت‌های مقاله (HTML/Tailwind). تعامل: کلیک روی یک کارت، جزئیات کامل مقاله را نمایش می‌دهد. توجیه: یک الگوی آشنا و موثر برای مرور محتوا. کتابخانه: جاوااسکریپت خالص (Vanilla JS).
        - اطلاعات گزارش: محتوای کامل مقاله. هدف: امکان مطالعه عمیق. بصری‌سازی/ارائه: نمای تمیز و خوانا و تک ستونی برای متن و تصویر مقاله. تعامل: یک دکمه 'بازگشت' برای بازگشت به لیست. توجیه: توجه کاربر را بدون حواس‌پرتی روی محتوا متمرکز می‌کند. کتابخانه: جاوااسکریپت خالص (Vanilla JS).
    -->
    <!-- تأیید: هیچ گرافیک SVG استفاده نشده است. هیچ کتابخانه Mermaid JS استفاده نشده است. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #F8F7F4; /* رنگ خنثی و گرم برای پس‌زمینه */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 40vh;
        }
        .prose {
            line-height: 1.75;
        }
        .prose h1, .prose h2, .prose h3 {
            font-weight: 700;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        .prose p {
            margin-bottom: 1em;
        }
    </style>
    <!-- مسیر آیکون اصلی سایت (favicon) -->
    <link rel="icon" href="/images/icons/my-app-icon.png" type="image/png"> 
    <!-- مسیر آیکون برای دستگاه‌های اپل (برای افزودن به صفحه اصلی) -->
    <link rel="apple-touch-icon" href="/images/icons/my-app-icon.png">
    <!-- لینک به فایل Manifest برای قابلیت PWA و نمایش آیکون روی صفحه اصلی گوشی -->
    <link rel="manifest" href="/manifest.json"> 

</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-green-800">داشبورد تحلیل هوشمند اخبار</h1>
            <p class="text-lg text-gray-600 mt-2">کاوش تعاملی در آخرین رویدادها و دسته‌بندی‌ها</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- ستون سمت راست (فیلترها و نمودار) -->
            <aside class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg h-fit lg:sticky top-8">
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-green-200 pb-3">ابزارهای کاوش</h2>
                
                <!-- بخش جستجو -->
                <div class="mb-6">
                    <label for="search-input" class="font-bold text-gray-700 block mb-2">جستجو در عناوین</label>
                    <input type="text" id="search-input" placeholder="مثال: هوش مصنوعی" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition">
                </div>

                <!-- بخش دسته‌بندی‌ها -->
                <div class="mb-8">
                    <h3 class="font-bold text-gray-700 block mb-3">فیلتر بر اساس دسته‌بندی</h3>
                    <div id="category-filters" class="space-y-2">
                        <!-- دکمه‌های فیلتر به صورت پویا اینجا اضافه می‌شوند -->
                    </div>
                </div>

                <!-- نمودار توزیع اخبار -->
                <div>
                    <h3 class="font-bold text-gray-700 block mb-4 text-center">توزیع اخبار بر اساس موضوع</h3>
                    <div class="chart-container">
                        <canvas id="category-chart"></canvas>
                    </div>
                </div>
            </aside>

            <!-- ستون سمت چپ (محتوای اصلی) -->
            <section id="content-area" class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                <!-- محتوای مقالات یا جزئیات مقاله اینجا نمایش داده می‌شود -->
            </section>

        </main>
    </div>

    <script>
        // ثبت Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        const newsData = [
          {
            id: '1',
            title: 'تغییرات اقلیمی و آینده سیاره زمین',
            imageUrl: 'https://placehold.co/800x400/A3BEAD/364E3A?text=Climate', /* تصویر placeholder */
            summary: 'مقاله ای جامع در مورد آخرین تحولات تغییرات اقلیمی، اثرات آن بر محیط زیست و راهکارهای جهانی برای مقابله با آن.',
            content: `<h1>بحران جهانی تغییرات اقلیمی</h1><p>تغییرات اقلیمی یکی از بزرگترین چالش‌های پیش روی بشریت در قرن 21 است. افزایش دمای جهانی، ذوب شدن یخچال‌های طبیعی، بالا آمدن سطح دریاها، و پدیده‌های آب و هوایی شدیدتر از جمله پیامدهای این پدیده هستند.</p><h2>تاثیرات بر محیط زیست و جوامع</h2><p>اثرات تغییرات اقلیمی بر محیط زیست گسترده و عمیق است. اکوسیستم‌ها در حال دگرگونی هستند، گونه‌های جانوری و گیاهی با خطر انقراض مواجه‌اند، و امنیت غذایی و آبی در بسیاری از مناطق جهان به خطر افتاده است. جوامع انسانی نیز از این تاثیرات در امان نیستند.</p><h3>راهکارهای مقابله و آینده</h3><p>مقابله با تغییرات اقلیمی نیازمند یک رویکرد جامع و هماهنگ جهانی است. کاهش انتشار گازهای گلخانه‌ای از طریق گذار به انرژی‌های تجدیدپذیر، افزایش بهره‌وری انرژی، و توسعه فناوری‌های سبز از جمله اقدامات کلیدی هستند.</p>`,
            timestamp: new Date().setHours(10, 30, 0, 0),
            category: 'محیط زیست'
          },
          {
            id: '2',
            title: 'پیشرفت‌های اخیر در هوش مصنوعی',
            imageUrl: 'https://placehold.co/800x400/C6D4B9/4F5B47?text=AI', /* تصویر placeholder */
            summary: 'مروری بر تازه‌ترین دستاوردهای هوش مصنوعی در زمینه‌های مختلف از جمله پردازش زبان طبیعی و بینایی کامپیوتر.',
            content: `<h1>انقلاب هوش مصنوعی در راه است</h1><p>هوش مصنوعی (AI) به سرعت در حال پیشرفت است و مرزهای آنچه را که ماشین‌ها می‌توانند انجام دهند، جابجا می‌کند. از پردازش زبان طبیعی (NLP) و تشخیص تصویر گرفته تا رباتیک پیشرفته، کاربردهای AI در حال تغییر زندگی روزمره و صنایع مختلف هستند.</p><h2>کاربردهای نوین</h2><p>در حوزه پزشکی، AI به تشخیص زودهنگام بیماری‌ها و کشف داروهای جدید کمک می‌کند. در بخش حمل‌ونقل، وسایل نقلیه خودران در حال توسعه هستند. در امور مالی، AI برای تحلیل بازار و شناسایی تقلب به کار می‌رود.</p>`,
            timestamp: new Date().setHours(11, 0, 0, 0),
            category: 'فناوری'
          },
          {
            id: '3',
            title: 'اقتصاد جهانی در سال ۲۰۲۵',
            imageUrl: 'https://placehold.co/800x400/D6E0C7/234723?text=Economy', /* تصویر placeholder */
            summary: 'تحلیلی از وضعیت فعلی اقتصاد جهانی و پیش‌بینی‌های کارشناسان برای سال آینده با تمرکز بر تورم و رشد اقتصادی.',
            content: `<h1>چشم‌انداز اقتصادی جهان</h1><p>اقتصاد جهانی در سال 2025 با مجموعه‌ای از فرصت‌ها و چالش‌ها مواجه است. پس از دوران پرنوسان اخیر، پیش‌بینی‌ها نشان‌دهنده یک رشد متعادل‌تر هستند، اما عوامل متعددی می‌توانند بر این مسیر تأثیر بگذارند.</p><h2>تورم و سیاست‌های پولی</h2><p>یکی از نگرانی‌های اصلی، ادامه تورم در برخی مناطق است. بانک‌های مرکزی با چالش متعادل کردن کنترل تورم و حمایت از رشد اقتصادی روبرو هستند.</p>`,
            timestamp: new Date().setHours(9, 45, 0, 0),
            category: 'اقتصاد'
          },
          {
            id: '4',
            title: 'اهمیت تغذیه سالم در پیشگیری از بیماری‌ها',
            imageUrl: 'https://placehold.co/800x400/C5EABF/57534E?text=Health', /* تصویر placeholder */
            summary: 'بررسی نقش کلیدی رژیم غذایی سالم و متوازن در حفظ سلامتی و کاهش خطر ابتلا به بیماری‌های مزمن.',
            content: `<h1>تغذیه سالم: پایه و اساس سلامتی</h1><p>تغذیه سالم و متوازن نه تنها برای حفظ انرژی و فعالیت روزمره ضروری است، بلکه نقش حیاتی در پیشگیری از بسیاری از بیماری‌های مزمن ایفا می‌کند. رژیم غذایی سرشار از میوه‌ها، سبزیجات، غلات کامل، پروتئین‌های بدون چربی و چربی‌های سالم، بدن را با مواد مغذی مورد نیاز تجهیز می‌کند.</p>`,
            timestamp: new Date().setHours(14, 15, 0, 0),
            category: 'سلامت'
          },
          {
            id: '5',
            title: 'فناوری‌های نوین در انرژی‌های تجدیدپذیر',
            imageUrl: 'https://placehold.co/800x400/E8ECDE/234723?text=Energy', /* تصویر placeholder */
            summary: 'نگاهی به آخرین نوآوری‌ها در زمینه انرژی خورشیدی، بادی، و سایر منابع تجدیدپذیر که آینده انرژی جهان را شکل می‌دهند.',
            content: `<h1>آینده انرژی: تجدیدپذیر و پایدار</h1><p>انرژی‌های تجدیدپذیر به عنوان ستون فقرات آینده انرژی جهان شناخته می‌شوند. با توجه به نگرانی‌های فزاینده در مورد تغییرات اقلیمی و کاهش منابع فسیلی، نوآوری در این حوزه با سرعت چشمگیری در حال پیشرفت است.</p>`,
            timestamp: new Date().setHours(16, 0, 0, 0),
            category: 'فناوری'
          }
        ];

        const contentArea = document.getElementById('content-area');
        const categoryFiltersContainer = document.getElementById('category-filters');
        const searchInput = document.getElementById('search-input');
        let categoryChart;

        /* تابع برای فرمت کردن تاریخ */
        const formatTimestamp = (timestamp) => new Date(timestamp).toLocaleString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' });
        
        /* تابع برای نمایش لیست مقالات */
        function displayArticles(articles) {
            contentArea.innerHTML = `<h2 class="text-3xl font-bold mb-6">آخرین اخبار</h2><div id="article-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>`;
            const articleGrid = document.getElementById('article-grid');
            if (articles.length === 0) {
                articleGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">مقاله‌ای با این مشخصات یافت نشد.</p>';
                return;
            }
            articles.forEach(article => {
                const articleCard = document.createElement('div');
                articleCard.className = 'bg-gray-50 rounded-xl shadow-md overflow-hidden transform transition-all duration-300 hover:shadow-xl hover:-translate-y-1 cursor-pointer';
                articleCard.innerHTML = `
                    <img class="h-48 w-full object-cover" src="${article.imageUrl}" alt="${article.title}">
                    <div class="p-5">
                        <div class="uppercase tracking-wide text-sm text-green-600 font-semibold">${article.category}</div>
                        <h3 class="block mt-1 text-lg leading-tight font-bold text-black hover:underline">${article.title}</h3>
                        <p class="mt-2 text-gray-500 text-sm">${article.summary}</p>
                        <p class="mt-3 text-xs text-gray-400">${formatTimestamp(article.timestamp)}</p>
                    </div>
                `;
                articleCard.addEventListener('click', () => displayArticleDetail(article.id));
                articleGrid.appendChild(articleCard);
            });
        }

        /* تابع برای نمایش جزئیات یک مقاله */
        function displayArticleDetail(articleId) {
            const article = newsData.find(a => a.id === articleId);
            contentArea.innerHTML = `
                <button id="back-button" class="mb-6 bg-green-600 text-white py-2 px-5 rounded-lg hover:bg-green-700 transition-colors">بازگشت به لیست اخبار</button>
                <article>
                    <h1 class="text-4xl font-extrabold text-gray-900 mb-4">${article.title}</h1>
                    <div class="flex items-center text-sm text-gray-500 mb-6">
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full">${article.category}</span>
                        <span class="mx-3">|</span>
                        <span>${formatTimestamp(article.timestamp)}</span>
                    </div>
                    <img class="rounded-xl w-full h-80 object-cover mb-8 shadow-lg" src="${article.imageUrl}" alt="${article.title}">
                    <div class="prose max-w-none">
                        ${marked.parse(article.content)}
                    </div>
                     <button id="summarize-button" class="mt-6 bg-blue-600 text-white py-2 px-5 rounded-lg hover:bg-blue-700 transition-colors">خلاصه‌سازی با هوش مصنوعی</button>
                    <div id="summary-output" class="mt-4 text-gray-700"></div>
                     <div id="summary-error" class="text-red-500 text-sm mt-2"></div>
                </article>
            `;
            document.getElementById('back-button').addEventListener('click', () => {
                displayArticles(newsData);
                updateActiveFilter('all');
            });

            document.getElementById('summarize-button').addEventListener('click', async () => {
                 const summarizeBtn = document.getElementById('summarize-button');
                 const summaryOutput = document.getElementById('summary-output');
                 const summaryErrorDiv = document.getElementById('summary-error');

                 summaryOutput.innerHTML = '';
                 summaryErrorDiv.innerHTML = '';
                 summarizeBtn.disabled = true;
                 summarizeBtn.textContent = 'در حال خلاصه‌سازی...';
                 summarizeBtn.classList.add('bg-gray-400');
                 summarizeBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');

                 try {
                     const articleContent = article.content; /* محتوای مقاله را برای خلاصه‌سازی ارسال می‌کنیم. */
                     /* آدرس Netlify Function ما. این آدرس به صورت خودکار توسط Netlify ایجاد می‌شود. */
                     const functionUrl = '/.netlify/functions/summarize-news'; 

                     const response = await fetch(functionUrl, {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({ articleContent }), /* محتوای مقاله را در بدنه درخواست ارسال می‌کنیم. */
                     });

                     if (!response.ok) {
                         const errorData = await response.json();
                         throw new Error(errorData.error.message || 'دریافت خلاصه از Netlify Function با خطا مواجه شد');
                     }

                     const result = await response.json();
                     if (result.summary) {
                         summaryOutput.innerHTML = `<div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mt-4"><p class="font-bold">خلاصه هوش مصنوعی:</p><p>${result.summary}</p></div>`;
                     } else {
                         throw new Error('خلاصه‌ای از Function دریافت نشد.');
                     }
                 } catch (error) {
                     summaryErrorDiv.innerHTML = `<div class="bg-red-50 p-4 rounded-lg border border-red-200 mt-4">خطا در خلاصه‌سازی: ${error.message}. لطفاً از تنظیم بودن Netlify Function و API Key اطمینان حاصل کنید.</div>`;
                 } finally {
                     summarizeBtn.disabled = false;
                     summarizeBtn.textContent = 'خلاصه‌سازی با هوش مصنوعی';
                     summarizeBtn.classList.remove('bg-gray-400');
                     summarizeBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                 }
             });
        }

        /* تابع برای ساخت دکمه‌های فیلتر */
        function createCategoryFilters() {
            const categories = ['all', ...new Set(newsData.map(a => a.category))];
            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category === 'all' ? 'همه دسته‌بندی‌ها' : category;
                button.dataset.category = category;
                button.className = `w-full text-right p-3 rounded-lg transition-colors duration-200 filter-btn`;
                button.classList.add(category === 'all' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-green-200');
                button.addEventListener('click', () => filterByCategory(category));
                categoryFiltersContainer.appendChild(button);
            });
        }
        
        /* تابع برای به‌روزرسانی ظاهر دکمه فیلتر فعال */
        function updateActiveFilter(activeCategory) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.category === activeCategory) {
                    btn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-green-200');
                    btn.classList.add('bg-green-600', 'text-white');
                } else {
                    btn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-green-200');
                    btn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-green-200');
                }
            });
        }

        /* تابع برای فیلتر کردن بر اساس دسته‌بندی */
        function filterByCategory(category) {
            searchInput.value = '';
            const filteredArticles = category === 'all' 
                ? newsData 
                : newsData.filter(a => a.title.toLowerCase().includes(term));
            displayArticles(filteredArticles);
            updateActiveFilter(null); 
        }

        /* تابع برای ساخت نمودار */
        function createChart() {
            const ctx = document.getElementById('category-chart').getContext('2d');
            const categories = [...new Set(newsData.map(a => a.category))];
            const data = categories.map(cat => newsData.filter(a => a.category === cat).length);
            
            const backgroundColors = [
                '#4CAF50', '#8BC34A', '#CDDC39', '#FFC107', '#FF9800',
            ];

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'تعداد اخبار',
                        data: data,
                        backgroundColor: backgroundColors.slice(0, categories.length),
                        borderColor: '#F8F7F4',
                        borderWidth: 4,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Vazirmatn'
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            bodyFont: {
                                family: 'Vazirmatn'
                            },
                            titleFont: {
                                family: 'Vazirmatn'
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const chartElement = elements[0];
                            const category = categoryChart.data.labels[chartElement.index];
                            filterByCategory(category);
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            displayArticles(newsData);
            createCategoryFilters();
            createChart();
            searchInput.addEventListener('input', (e) => filterBySearch(e.target.value));
        });

    </script>
</body>
</html>
